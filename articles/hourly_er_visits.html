<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Time Series Modeling with Multiple Modes • fastTS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Time Series Modeling with Multiple Modes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fastTS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/case_studies.html">Simple Case Studies</a></li>
    <li><a class="dropdown-item" href="../articles/forecasting.html">Forecasting with fastTS</a></li>
    <li><a class="dropdown-item" href="../articles/hourly_er_visits.html">Time Series Modeling with Multiple Modes</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/petersonR/fastTS/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="hourly_er_visits_files/kePrint-0.0.1/kePrint.js"></script><link href="hourly_er_visits_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Time Series Modeling with Multiple Modes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/petersonR/fastTS/blob/v1.0.2/vignettes/hourly_er_visits.Rmd" class="external-link"><code>vignettes/hourly_er_visits.Rmd</code></a></small>
      <div class="d-none name"><code>hourly_er_visits.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-uihc_ed_arrivals-data-set">The <code>uihc_ed_arrivals</code> data set<a class="anchor" aria-label="anchor" href="#the-uihc_ed_arrivals-data-set"></a>
</h2>
<p>The University of Iowa Hospitals and Clinics (UIHC) Emergency
Department Arrivals data set is included as a component of this package,
and consists of 41,640 hourly counts of number of new arrivals into the
ED spanning the years 2013-2018. See the data set documentation,
<code><a href="../reference/uihc_ed_arrivals.html">?uihc_ed_arrivals</a></code>, for more information.</p>
</div>
<div class="section level2">
<h2 id="modeling-the-data">Modeling the data<a class="anchor" aria-label="anchor" href="#modeling-the-data"></a>
</h2>
<div class="section level3">
<h3 id="endogenous-model-srlpac">Endogenous model (SRLPAC)<a class="anchor" aria-label="anchor" href="#endogenous-model-srlpac"></a>
</h3>
<p>First we’ll load and summarize the data. Note that although we have
plenty of information on year, month, and day, the data set has already
been sorted by time.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"uihc_ed_arrivals"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">uihc_ed_arrivals</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    41640 obs. of  17 variables:</span></span>
<span><span class="co">#&gt;  $ Year    : num  2013 2013 2013 2013 2013 ...</span></span>
<span><span class="co">#&gt;  $ Quarter : Factor w/ 4 levels "Q1","Q2","Q3",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ Month   : num  7 7 7 7 7 7 7 7 7 7 ...</span></span>
<span><span class="co">#&gt;  $ Day     : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ Hour    : num  0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">#&gt;  $ Arrivals: num  5 5 8 2 2 1 4 1 4 6 ...</span></span>
<span><span class="co">#&gt;  $ Date    : Date, format: "2013-07-01" "2013-07-01" ...</span></span>
<span><span class="co">#&gt;  $ Weekday : Ord.factor w/ 7 levels "Sun"&lt;"Mon"&lt;"Tue"&lt;..: 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">#&gt;  $ temp    : num  57 57 57 56 56 57 59 60 60 61 ...</span></span>
<span><span class="co">#&gt;  $ xmas    : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ xmas2   : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ nye     : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ nyd     : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ thx     : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ thx1    : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ ind     : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ game_day: num  0 0 0 0 0 0 0 0 0 0 ...</span></span></code></pre></div>
<p>Let’s pull out our outcome and look at it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">uihc_ed_arrivals</span><span class="op">$</span><span class="va">Arrivals</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<p><img src="hourly_er_visits_files/figure-html/plot_outcome-1.png" width="672"></p>
<p>OK, not too helpful visually. Such is the trap of being so close to
asymptopia. Let’s look a bit closer at the partial autocorrelation
function to see what kind of seasonality and autoregressive (AR)
structure we could be dealing with.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># number of maximum lags to consider</span></span>
<span><span class="va">n_lags_max</span> <span class="op">&lt;-</span> <span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">*</span><span class="fl">5</span> <span class="co"># consider 5 weeks' data lags</span></span>
<span><span class="va">pacfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">pacf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, lag.max <span class="op">=</span> <span class="va">n_lags_max</span>, plot <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pacfs</span><span class="op">)</span></span></code></pre></div>
<p><img src="hourly_er_visits_files/figure-html/plot_pacf-1.png" width="672"></p>
<p>Clearly we have multiple modes of seasonality in this hourly data,
likely corresponding to observed shift-based, daily, and weekly
patterns. Thankfully the sparsity ranked lasso (SRL) time series fitting
procedure can handle this situation in stride.</p>
<p>We can fit an endogenous SRLPAC model using one line of code which
might take 1-2 minutes to run:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srlpac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fastTS.html">fastTS</a></span><span class="op">(</span><span class="va">y</span>, n_lags_max <span class="op">=</span> <span class="va">n_lags_max</span>, ptrain <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span></code></pre></div>
<p>We can investigate the performance of the SRLPAC model using
associated <code>print</code>, <code>coef</code>, <code>summary</code>,
and <code>plot</code> functions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srlpac</span></span>
<span><span class="co">#&gt; An endogenous PACF-based fastTS model.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  PF_gamma   AICc_d    BIC_d</span></span>
<span><span class="co">#&gt;      0.00    73.99   292.98</span></span>
<span><span class="co">#&gt;      0.25    11.63    20.55</span></span>
<span><span class="co">#&gt;      0.50      *0*      *0*</span></span>
<span><span class="co">#&gt;      1.00   345.67    80.13</span></span>
<span><span class="co">#&gt;      2.00  2719.38  2139.19</span></span>
<span><span class="co">#&gt;      4.00  8347.84  7640.05</span></span>
<span><span class="co">#&gt;      8.00 15920.25 15152.91</span></span>
<span><span class="co">#&gt;     16.00 15920.25 15152.91</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; AICc_d and BIC_d are the difference from the minimum; *0* is best.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Best AICc model: 167 active terms</span></span>
<span><span class="co">#&gt; - Best BIC  model: 68 active terms</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Test-set prediction accuracy (10% held-out test set)</span></span>
<span><span class="co">#&gt;          rmse       rsq      mae</span></span>
<span><span class="co">#&gt; AICc 2.651049 0.5276457 2.050730</span></span>
<span><span class="co">#&gt; BIC  2.656269 0.5257839 2.057091</span></span></code></pre></div>
<p>By default, <code>fastTS</code> used 8 possible tuning parameters for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>,
the penalty weight exponent, and using AICc as a judge it appears the
best value is 0.5. By default, the argument <code>p_train</code> is set
to 0.8, which means we also get prediction accuracy for a left-out 20%
of the data, and revealing an R-squared of 53.1%, meaning that about
half of the variance in hourly visits to the ED can be explained by
multi-modal seasonal and local autoregressive patterns.</p>
<p>The lasso’s solution path for these lags can be seen via the
<code>plot</code> function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">srlpac</span><span class="op">)</span></span></code></pre></div>
<p><img src="hourly_er_visits_files/figure-html/plot_endo-1.png" width="672"></p>
<p>To see the (long) list of selected coefficients, the
<code>summary</code> function can be used.</p>
<details><summary>
Expand to see output
</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">srlpac</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model summary (ncvreg) at optimal AICc (lambda=0.0017; gamma=0.5)</span></span>
<span><span class="co">#&gt; lasso-penalized linear regression with n=36636, p=840</span></span>
<span><span class="co">#&gt; At lambda=0.0017:</span></span>
<span><span class="co">#&gt; -------------------------------------------------</span></span>
<span><span class="co">#&gt;   Nonzero coefficients         : 166</span></span>
<span><span class="co">#&gt;   Expected nonzero coefficients:  89.94</span></span>
<span><span class="co">#&gt;   Average mfdr (166 features)  :   0.542</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate       z       mfdr Selected</span></span>
<span><span class="co">#&gt; lag1    4.832e-02 13.8334    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag168  3.128e-02  9.3035    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag336  2.913e-02  8.8062    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag504  2.838e-02  8.7034    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag840  2.611e-02  8.2193    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag672  2.614e-02  8.1720    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag337  2.578e-02  7.9079    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag671  2.497e-02  7.8255    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag503  2.419e-02  7.5314    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag170  2.394e-02  7.3430    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag167  2.374e-02  7.1869    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag673  2.212e-02  7.0841    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag47   2.285e-02  6.8408    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag505  2.088e-02  6.6926    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag335  2.142e-02  6.6878    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag2    2.233e-02  6.5631    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag72   2.081e-02  6.3162    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag3    2.046e-02  6.2389    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag96   2.016e-02  6.1570    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag432  1.813e-02  5.9159    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag73   1.816e-02  5.6173    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag144  1.777e-02  5.5418    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag839  1.594e-02  5.5196    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag23   1.807e-02  5.4146    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag169  1.695e-02  5.3612    &lt; 1e-04        *</span></span>
<span><span class="co">#&gt; lag166  1.578e-02  5.0024 0.00013304        *</span></span>
<span><span class="co">#&gt; lag24   1.646e-02  4.9811 0.00014421        *</span></span>
<span><span class="co">#&gt; lag647  1.399e-02  4.8894 0.00020612        *</span></span>
<span><span class="co">#&gt; lag192  1.481e-02  4.8607 0.00023170        *</span></span>
<span><span class="co">#&gt; lag528  1.313e-02  4.7248 0.00041199        *</span></span>
<span><span class="co">#&gt; lag25   1.499e-02  4.6212 0.00064414        *</span></span>
<span><span class="co">#&gt; lag600  1.243e-02  4.4974 0.00109781        *</span></span>
<span><span class="co">#&gt; lag190  1.329e-02  4.4680 0.00124702        *</span></span>
<span><span class="co">#&gt; lag22   1.469e-02  4.4586 0.00129820        *</span></span>
<span><span class="co">#&gt; lag71   1.370e-02  4.3025 0.00250449        *</span></span>
<span><span class="co">#&gt; lag338  1.237e-02  4.2944 0.00258411        *</span></span>
<span><span class="co">#&gt; lag674  1.076e-02  4.0905 0.00507800        *</span></span>
<span><span class="co">#&gt; lag283 -1.279e-02 -4.4935 0.00550651        *</span></span>
<span><span class="co">#&gt; lag191  1.188e-02  4.0510 0.00566295        *</span></span>
<span><span class="co">#&gt; lag312  1.143e-02  3.9938 0.00662490        *</span></span>
<span><span class="co">#&gt; lag648  1.017e-02  3.9094 0.00847559        *</span></span>
<span><span class="co">#&gt; lag838  9.762e-03  3.8902 0.00900218        *</span></span>
<span><span class="co">#&gt; lag481  1.064e-02  3.8646 0.00978850        *</span></span>
<span><span class="co">#&gt; lag241  1.064e-02  3.7938 0.01257043        *</span></span>
<span><span class="co">#&gt; lag263  1.062e-02  3.7646 0.01404710        *</span></span>
<span><span class="co">#&gt; lag670  9.846e-03  3.7290 0.01619361        *</span></span>
<span><span class="co">#&gt; lag143  1.117e-02  3.7159 0.01710427        *</span></span>
<span><span class="co">#&gt; lag649  9.386e-03  3.6818 0.01973798        *</span></span>
<span><span class="co">#&gt; lag644 -1.142e-02 -4.1916 0.02004784        *</span></span>
<span><span class="co">#&gt; lag696  8.329e-03  3.6545 0.02218302        *</span></span>
<span><span class="co">#&gt; lag360  8.925e-03  3.4680 0.04644124        *</span></span>
<span><span class="co">#&gt; lag502  9.070e-03  3.4593 0.04782684        *</span></span>
<span><span class="co">#&gt; lag506  8.383e-03  3.4020 0.05656526        *</span></span>
<span><span class="co">#&gt; lag462 -9.032e-03 -3.5147 0.07544922        *</span></span>
<span><span class="co">#&gt; lag212 -8.826e-03 -3.4942 0.07740615        *</span></span>
<span><span class="co">#&gt; lag700 -8.677e-03 -3.4654 0.08102706        *</span></span>
<span><span class="co">#&gt; lag4    9.476e-03  3.2218 0.08513626        *</span></span>
<span><span class="co">#&gt; lag770  7.547e-03  3.1949 0.09050678        *</span></span>
<span><span class="co">#&gt; lag288  8.157e-03  3.1730 0.09545128        *</span></span>
<span><span class="co">#&gt; lag6    9.919e-03  3.1411 0.10355275        *</span></span>
<span><span class="co">#&gt; lag119  9.133e-03  3.1349 0.10529360        *</span></span>
<span><span class="co">#&gt; lag317 -8.195e-03 -3.3438 0.10827871        *</span></span>
<span><span class="co">#&gt; lag26   9.165e-03  3.0991 0.11650038        *</span></span>
<span><span class="co">#&gt; lag480  7.304e-03  3.0785 0.12392532        *</span></span>
<span><span class="co">#&gt; lag816  6.479e-03  3.0524 0.13488996        *</span></span>
<span><span class="co">#&gt; lag685 -6.883e-03 -3.2704 0.13679117        *</span></span>
<span><span class="co">#&gt; lag533 -7.910e-03 -3.2636 0.13999713        *</span></span>
<span><span class="co">#&gt; lag817  6.235e-03  3.0378 0.14150660        *</span></span>
<span><span class="co">#&gt; lag7    9.577e-03  3.0323 0.14425271        *</span></span>
<span><span class="co">#&gt; lag214  7.360e-03  2.9473 0.19878897        *</span></span>
<span><span class="co">#&gt; lag116 -7.533e-03 -3.1542 0.20217850        *</span></span>
<span><span class="co">#&gt; lag121  7.902e-03  2.8451 0.30811774        *</span></span>
<span><span class="co">#&gt; lag489 -7.001e-03 -2.9682 0.31653617        *</span></span>
<span><span class="co">#&gt; lag142  7.690e-03  2.7934 0.38793357        *</span></span>
<span><span class="co">#&gt; lag46   8.362e-03  2.7916 0.39102237        *</span></span>
<span><span class="co">#&gt; lag152 -7.118e-03 -2.8179 0.40070823        *</span></span>
<span><span class="co">#&gt; lag334  6.960e-03  2.7827 0.40662249        *</span></span>
<span><span class="co">#&gt; lag580 -5.584e-03 -2.7634 0.44275684        *</span></span>
<span><span class="co">#&gt; lag37  -7.508e-03 -2.7583 0.44745188        *</span></span>
<span><span class="co">#&gt; lag520 -5.889e-03 -2.7571 0.44849840        *</span></span>
<span><span class="co">#&gt; lag316 -5.746e-03 -2.7312 0.47297615        *</span></span>
<span><span class="co">#&gt; lag491 -4.946e-03 -2.6593 0.55827411        *</span></span>
<span><span class="co">#&gt; lag322 -5.256e-03 -2.6354 0.59201104        *</span></span>
<span><span class="co">#&gt; lag463 -5.281e-03 -2.5134 0.79196750        *</span></span>
<span><span class="co">#&gt; lag522 -4.762e-03 -2.4968 0.82077437        *</span></span>
<span><span class="co">#&gt; lag440  5.086e-03  2.5291 0.87977536        *</span></span>
<span><span class="co">#&gt; lag84  -2.297e-04 -0.9457 0.93033976        *</span></span>
<span><span class="co">#&gt; lag14  -3.126e-04 -0.5388 0.93880351        *</span></span>
<span><span class="co">#&gt; lag54  -9.170e-04 -1.0496 0.95233277        *</span></span>
<span><span class="co">#&gt; lag145  6.216e-03  2.4024 0.97682050        *</span></span>
<span><span class="co">#&gt; lag697  3.706e-03  2.3890 0.98385342        *</span></span>
<span><span class="co">#&gt; lag8    5.377e-03  1.8417 1.00000000        *</span></span>
<span><span class="co">#&gt; lag10   4.209e-03  1.5186 1.00000000        *</span></span>
<span><span class="co">#&gt; lag13   1.100e-03  0.7079 1.00000000        *</span></span>
<span><span class="co">#&gt; lag15   8.068e-04  0.8520 1.00000000        *</span></span>
<span><span class="co">#&gt; lag18   2.555e-03  1.3921 1.00000000        *</span></span>
<span><span class="co">#&gt; lag21   5.752e-03  1.9600 1.00000000        *</span></span>
<span><span class="co">#&gt; lag34   1.044e-04  0.8149 1.00000000        *</span></span>
<span><span class="co">#&gt; lag52  -3.382e-03 -1.8283 1.00000000        *</span></span>
<span><span class="co">#&gt; lag55   1.327e-04  2.3267 1.00000000        *</span></span>
<span><span class="co">#&gt; lag64   1.444e-03  1.6590 1.00000000        *</span></span>
<span><span class="co">#&gt; lag70   5.290e-03  1.9913 1.00000000        *</span></span>
<span><span class="co">#&gt; lag74   3.526e-03  1.6954 1.00000000        *</span></span>
<span><span class="co">#&gt; lag76  -4.207e-03 -2.1447 1.00000000        *</span></span>
<span><span class="co">#&gt; lag95   5.916e-04  0.7312 1.00000000        *</span></span>
<span><span class="co">#&gt; lag97   3.450e-03  1.5648 1.00000000        *</span></span>
<span><span class="co">#&gt; lag120  5.638e-03  2.1829 1.00000000        *</span></span>
<span><span class="co">#&gt; lag133 -6.336e-04 -1.3573 1.00000000        *</span></span>
<span><span class="co">#&gt; lag141  5.578e-03  2.2978 1.00000000        *</span></span>
<span><span class="co">#&gt; lag148 -3.279e-03 -1.9375 1.00000000        *</span></span>
<span><span class="co">#&gt; lag149 -1.272e-03 -1.3516 1.00000000        *</span></span>
<span><span class="co">#&gt; lag150 -4.134e-03 -2.0763 1.00000000        *</span></span>
<span><span class="co">#&gt; lag154 -2.606e-03 -1.6541 1.00000000        *</span></span>
<span><span class="co">#&gt; lag172 -4.161e-03 -2.2711 1.00000000        *</span></span>
<span><span class="co">#&gt; lag185 -1.227e-03 -1.4276 1.00000000        *</span></span>
<span><span class="co">#&gt; lag193  1.638e-03  1.4142 1.00000000        *</span></span>
<span><span class="co">#&gt; lag216  2.812e-03  1.7056 1.00000000        *</span></span>
<span><span class="co">#&gt; lag239  1.924e-03  1.4977 1.00000000        *</span></span>
<span><span class="co">#&gt; lag255  4.054e-04  1.3612 1.00000000        *</span></span>
<span><span class="co">#&gt; lag264  1.282e-03  1.2839 1.00000000        *</span></span>
<span><span class="co">#&gt; lag266  6.112e-04  1.2681 1.00000000        *</span></span>
<span><span class="co">#&gt; lag287  3.561e-03  1.9931 1.00000000        *</span></span>
<span><span class="co">#&gt; lag311  3.634e-03  1.9446 1.00000000        *</span></span>
<span><span class="co">#&gt; lag315 -7.311e-04 -1.5680 1.00000000        *</span></span>
<span><span class="co">#&gt; lag354 -3.043e-04 -1.3601 1.00000000        *</span></span>
<span><span class="co">#&gt; lag356 -3.593e-03 -2.0771 1.00000000        *</span></span>
<span><span class="co">#&gt; lag378 -1.041e-03 -1.5192 1.00000000        *</span></span>
<span><span class="co">#&gt; lag384  2.089e-03  1.7697 1.00000000        *</span></span>
<span><span class="co">#&gt; lag397  3.425e-03  2.0249 1.00000000        *</span></span>
<span><span class="co">#&gt; lag399  8.276e-04  1.4562 1.00000000        *</span></span>
<span><span class="co">#&gt; lag406  2.982e-03  2.0384 1.00000000        *</span></span>
<span><span class="co">#&gt; lag408  2.958e-03  1.9697 1.00000000        *</span></span>
<span><span class="co">#&gt; lag461 -1.379e-03 -1.5807 1.00000000        *</span></span>
<span><span class="co">#&gt; lag477 -3.551e-03 -2.1067 1.00000000        *</span></span>
<span><span class="co">#&gt; lag479  4.055e-03  2.1982 1.00000000        *</span></span>
<span><span class="co">#&gt; lag492 -1.684e-03 -1.9215 1.00000000        *</span></span>
<span><span class="co">#&gt; lag515 -1.421e-03 -1.7696 1.00000000        *</span></span>
<span><span class="co">#&gt; lag518 -3.009e-03 -2.0826 1.00000000        *</span></span>
<span><span class="co">#&gt; lag519 -1.245e-03 -1.7359 1.00000000        *</span></span>
<span><span class="co">#&gt; lag524 -1.837e-03 -1.6917 1.00000000        *</span></span>
<span><span class="co">#&gt; lag532 -3.848e-03 -2.1992 1.00000000        *</span></span>
<span><span class="co">#&gt; lag547 -1.769e-03 -1.8280 1.00000000        *</span></span>
<span><span class="co">#&gt; lag553  4.045e-04  1.5840 1.00000000        *</span></span>
<span><span class="co">#&gt; lag568  1.031e-04  1.2304 1.00000000        *</span></span>
<span><span class="co">#&gt; lag579 -2.218e-03 -1.7556 1.00000000        *</span></span>
<span><span class="co">#&gt; lag611 -3.447e-03 -2.2112 1.00000000        *</span></span>
<span><span class="co">#&gt; lag615  4.221e-03  2.2616 1.00000000        *</span></span>
<span><span class="co">#&gt; lag643  8.495e-04  1.3665 1.00000000        *</span></span>
<span><span class="co">#&gt; lag660 -1.451e-03 -1.9181 1.00000000        *</span></span>
<span><span class="co">#&gt; lag677 -4.081e-03 -2.3519 1.00000000        *</span></span>
<span><span class="co">#&gt; lag712 -2.749e-03 -1.9713 1.00000000        *</span></span>
<span><span class="co">#&gt; lag716 -2.516e-03 -2.0212 1.00000000        *</span></span>
<span><span class="co">#&gt; lag722  2.626e-03  2.0303 1.00000000        *</span></span>
<span><span class="co">#&gt; lag723 -1.057e-03 -1.5367 1.00000000        *</span></span>
<span><span class="co">#&gt; lag724 -7.890e-04 -1.6821 1.00000000        *</span></span>
<span><span class="co">#&gt; lag727 -2.050e-03 -1.7763 1.00000000        *</span></span>
<span><span class="co">#&gt; lag733 -8.095e-04 -1.7718 1.00000000        *</span></span>
<span><span class="co">#&gt; lag744  2.234e-03  2.0510 1.00000000        *</span></span>
<span><span class="co">#&gt; lag747 -4.722e-04 -1.5162 1.00000000        *</span></span>
<span><span class="co">#&gt; lag749  4.085e-04  1.1317 1.00000000        *</span></span>
<span><span class="co">#&gt; lag753  1.922e-03  1.6696 1.00000000        *</span></span>
<span><span class="co">#&gt; lag769  9.107e-05  1.4103 1.00000000        *</span></span>
<span><span class="co">#&gt; lag779 -2.768e-03 -2.1869 1.00000000        *</span></span>
<span><span class="co">#&gt; lag781  2.550e-03  1.7091 1.00000000        *</span></span>
<span><span class="co">#&gt; lag792  3.355e-03  2.3111 1.00000000        *</span></span>
<span><span class="co">#&gt; lag819  2.919e-03  1.8711 1.00000000        *</span></span></code></pre></div>
</details>
</div>
<div class="section level3">
<h3 id="exogenous-model-srlpacx">Exogenous model (SRLPACx)<a class="anchor" aria-label="anchor" href="#exogenous-model-srlpacx"></a>
</h3>
<p>It’s slightly more work to add exogenous features, which might help
us add in fixed effects of weekday, temperature, and holiday indicators.
The extra work is setting up the matrix of exogenous features.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X_day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">uihc_ed_arrivals</span>, <span class="va">xmas</span><span class="op">:</span><span class="va">game_day</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X_month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/relevel.html" class="external-link">relevel</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Month</span><span class="op">)</span>, ref <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">temp</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>, </span>
<span>                        data <span class="op">=</span> <span class="va">uihc_ed_arrivals</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X_month</span>, <span class="va">X_day</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"relevel.factor.Month., ref = 3."</span>, <span class="st">"Month"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Month1 Month2 Month4 Month5 Month6 Month7 Month8 Month9 Month10 Month11</span></span>
<span><span class="co">#&gt; 1      0      0      0      0      0      1      0      0       0       0</span></span>
<span><span class="co">#&gt; 2      0      0      0      0      0      1      0      0       0       0</span></span>
<span><span class="co">#&gt; 3      0      0      0      0      0      1      0      0       0       0</span></span>
<span><span class="co">#&gt; 4      0      0      0      0      0      1      0      0       0       0</span></span>
<span><span class="co">#&gt; 5      0      0      0      0      0      1      0      0       0       0</span></span>
<span><span class="co">#&gt; 6      0      0      0      0      0      1      0      0       0       0</span></span>
<span><span class="co">#&gt;   Month12 I(temp/10) xmas xmas2 nye nyd thx thx1 ind game_day</span></span>
<span><span class="co">#&gt; 1       0        5.7    0     0   0   0   0    0   0        0</span></span>
<span><span class="co">#&gt; 2       0        5.7    0     0   0   0   0    0   0        0</span></span>
<span><span class="co">#&gt; 3       0        5.7    0     0   0   0   0    0   0        0</span></span>
<span><span class="co">#&gt; 4       0        5.6    0     0   0   0   0    0   0        0</span></span>
<span><span class="co">#&gt; 5       0        5.6    0     0   0   0   0    0   0        0</span></span>
<span><span class="co">#&gt; 6       0        5.7    0     0   0   0   0    0   0        0</span></span></code></pre></div>
<p>The result is a model matrix with month indicators (reference is
March), a scaled temperature covariate, and holiday indicator variables.
Now that we have our matrix of exogenous features, we can pass this to
<code>fastTS</code> to get our SRLPACx model. We also set
<code>w_exo="unpenalized"</code> which will allow us to conduct
statistical inference on the exogenous variable coefficients (by
default, they will be penalized using adaptive-lasso-style penalty
weights, which makes formal inference more difficult).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srlpacx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fastTS.html">fastTS</a></span><span class="op">(</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, n_lags_max <span class="op">=</span> <span class="va">n_lags_max</span>, w_exo <span class="op">=</span> <span class="st">"unpenalized"</span>, ptrain <span class="op">=</span> <span class="fl">.9</span><span class="op">)</span></span></code></pre></div>
<p>The same S3 methods apply and can be used to investigate the
performance of the SLRPACx model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srlpacx</span></span>
<span><span class="co">#&gt; A PACF-based fastTS model with 20 exogenous features.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  PF_gamma   AICc_d    BIC_d</span></span>
<span><span class="co">#&gt;      0.00    79.07   226.06</span></span>
<span><span class="co">#&gt;      0.25     29.1     9.74</span></span>
<span><span class="co">#&gt;      0.50      *0*      *0*</span></span>
<span><span class="co">#&gt;      1.00   347.06    48.11</span></span>
<span><span class="co">#&gt;      2.00  2618.52  1988.01</span></span>
<span><span class="co">#&gt;      4.00  7966.17  7208.09</span></span>
<span><span class="co">#&gt;      8.00 15351.43 14533.81</span></span>
<span><span class="co">#&gt;     16.00 15351.43 14533.81</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; AICc_d and BIC_d are the difference from the minimum; *0* is best.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Best AICc model: 212 active terms</span></span>
<span><span class="co">#&gt; - Best BIC  model: 97 active terms</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Test-set prediction accuracy (10% held-out test set)</span></span>
<span><span class="co">#&gt;          rmse       rsq      mae</span></span>
<span><span class="co">#&gt; AICc 2.645336 0.5296794 2.045353</span></span>
<span><span class="co">#&gt; BIC  2.648096 0.5286975 2.048818</span></span></code></pre></div>
<p>Again, <code>fastTS</code> used 8 possible tuning parameters for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>,
and it appears the best value is 0.5. The addition of exogenous features
has slightly improved the prediction accuracy on the left-out test data,
with an R-squared of 53.3%. This may appear to be a very small increase,
but it could add up (as we will see shortly) when predictions are made
multiple steps ahead, or when the cumulative sum of predictions is of
interest.</p>
<p>The lasso’s solution path for these lags can be seen via the
<code>plot</code> function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">srlpacx</span><span class="op">)</span></span></code></pre></div>
<p><img src="hourly_er_visits_files/figure-html/plot_exo-1.png" width="672"></p>
<p>To see the (long) list of selected coefficients, the
<code>summary</code> function can be used. In this case, we’re most
interested in the exogenous features, which can be extracted via the
<code>unpenTable</code> object in the results returned from
<code>summary</code> (this is thanks in large part to the
<code>ncvreg</code> package).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">srlpacx</span><span class="op">)</span></span>
<span><span class="va">s</span><span class="op">$</span><span class="va">unpenTable</span> </span></code></pre></div>
<table class="table  lightable-minimal" style='font-family: "Trebuchet MS", verdana, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:left;">
p.value
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Month1
</td>
<td style="text-align:right;">
0.09
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
1.32
</td>
<td style="text-align:left;">
0.19
</td>
</tr>
<tr>
<td style="text-align:left;">
Month2
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
0.60
</td>
<td style="text-align:left;">
0.55
</td>
</tr>
<tr>
<td style="text-align:left;">
Month4
</td>
<td style="text-align:right;">
-0.18
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
-2.58
</td>
<td style="text-align:left;">
0.010
</td>
</tr>
<tr>
<td style="text-align:left;">
Month5
</td>
<td style="text-align:right;">
-0.44
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
-5.97
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Month6
</td>
<td style="text-align:right;">
-0.63
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
-7.78
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Month7
</td>
<td style="text-align:right;">
-0.50
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
-6.10
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Month8
</td>
<td style="text-align:right;">
-0.41
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
-5.23
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Month9
</td>
<td style="text-align:right;">
-0.30
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
-3.94
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Month10
</td>
<td style="text-align:right;">
-0.45
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
-6.35
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Month11
</td>
<td style="text-align:right;">
-0.29
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
-4.13
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Month12
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
0.10
</td>
<td style="text-align:left;">
0.92
</td>
</tr>
<tr>
<td style="text-align:left;">
I(temp/10)
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
10.47
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
xmas
</td>
<td style="text-align:right;">
-1.45
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
-5.33
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
xmas2
</td>
<td style="text-align:right;">
0.74
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
2.73
</td>
<td style="text-align:left;">
0.006
</td>
</tr>
<tr>
<td style="text-align:left;">
nye
</td>
<td style="text-align:right;">
-0.51
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
-1.86
</td>
<td style="text-align:left;">
0.064
</td>
</tr>
<tr>
<td style="text-align:left;">
nyd
</td>
<td style="text-align:right;">
-0.12
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
-0.45
</td>
<td style="text-align:left;">
0.65
</td>
</tr>
<tr>
<td style="text-align:left;">
thx
</td>
<td style="text-align:right;">
-1.48
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
-5.44
</td>
<td style="text-align:left;">
&lt; 0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
thx1
</td>
<td style="text-align:right;">
0.43
</td>
<td style="text-align:right;">
0.28
</td>
<td style="text-align:right;">
1.57
</td>
<td style="text-align:left;">
0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
ind
</td>
<td style="text-align:right;">
-0.75
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
-2.77
</td>
<td style="text-align:left;">
0.006
</td>
</tr>
<tr>
<td style="text-align:left;">
game_day
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
0.10
</td>
<td style="text-align:right;">
0.09
</td>
<td style="text-align:left;">
0.92
</td>
</tr>
</tbody>
</table>
<p>Or we can make a nice looking figure.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">unpenTable</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">se_b</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">unpenTable</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">ci_lb</span> <span class="op">&lt;-</span> <span class="va">b</span> <span class="op">-</span> <span class="va">se_b</span> <span class="op">*</span> <span class="fl">1.96</span></span>
<span><span class="va">ci_ub</span> <span class="op">&lt;-</span> <span class="va">b</span> <span class="op">+</span> <span class="va">se_b</span> <span class="op">*</span> <span class="fl">1.96</span></span>
<span></span>
<span><span class="va">old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">9</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">b</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">se_b</span><span class="op">)</span><span class="op">:</span><span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">ci_lb</span>, <span class="va">ci_ub</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">20</span>,</span>
<span>     col <span class="op">=</span> <span class="fl">4</span>, yaxt <span class="op">=</span> <span class="st">"n"</span>, ylab <span class="op">=</span> <span class="st">""</span>, xlab <span class="op">=</span> <span class="st">"Coefficient (Change in Hourly ER visits)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html" class="external-link">segments</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="va">ci_lb</span>, x1 <span class="op">=</span> <span class="va">ci_ub</span>, y0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">se_b</span><span class="op">)</span><span class="op">:</span><span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"factor\\(Month\\)"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">month.name</span><span class="op">[</span><span class="op">-</span><span class="fl">3</span><span class="op">]</span>, <span class="st">"10-degree (F)"</span>, <span class="st">"Christmas"</span>, <span class="st">"Christmas+1"</span>,</span>
<span>          <span class="st">"New Year's Eve"</span>, <span class="st">"New Years Day"</span>,</span>
<span>          <span class="st">"Thanksgiving"</span>, <span class="st">"Thanksgiving+1"</span>, <span class="st">"Independence Day"</span>,</span>
<span>          <span class="st">"Hawkeye Gameday"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">se_b</span><span class="op">)</span><span class="op">:</span><span class="fl">1</span>, <span class="va">labs</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="hourly_er_visits_files/figure-html/plot_exo_coefs-1.png" width="672"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="making-predictions">Making predictions<a class="anchor" aria-label="anchor" href="#making-predictions"></a>
</h2>
<p>For time series models such as the ones we fit with SRLPAC, it is
straightforward to get 1-step-ahead predictions. By default, these
predictions will include both in-sample and out-of-sample (test set)
predictions; see below for how to delineate between these two.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_1step_endo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpac</span><span class="op">)</span></span>
<span><span class="va">p_1step_exo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpacx</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="k-step-ahead-predictions">k-step ahead predictions<a class="anchor" aria-label="anchor" href="#k-step-ahead-predictions"></a>
</h3>
<p>It’s a bit more involved of a process to get 2, 3, or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>-step
ahead predictions computationally, as the the 1-step through
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k-1</annotation></semantics></math>-step
predictions must be computed iteratively in order to get
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>-step
ahead predictions. From a user’s perspective, it’s still straightforward
though.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_2step_endo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpac</span>, n_ahead <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">p_2step_exo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpacx</span>, n_ahead <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_10step_endo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpac</span>, n_ahead <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">p_10step_exo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpacx</span>, n_ahead <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">p_1step_endo</span>, <span class="va">p_2step_endo</span>, <span class="va">p_10step_endo</span>, </span>
<span>               <span class="va">p_1step_exo</span>, <span class="va">p_2step_exo</span>, <span class="va">p_10step_exo</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">preds</span>, use <span class="op">=</span> <span class="st">"pairwise"</span><span class="op">)</span></span>
<span><span class="co">#&gt;               p_1step_endo p_2step_endo p_10step_endo p_1step_exo p_2step_exo</span></span>
<span><span class="co">#&gt; p_1step_endo     1.0000000    0.9990044     0.9983291   0.9971924   0.9962132</span></span>
<span><span class="co">#&gt; p_2step_endo     0.9990044    1.0000000     0.9993251   0.9962292   0.9969484</span></span>
<span><span class="co">#&gt; p_10step_endo    0.9983291    0.9993251     1.0000000   0.9955017   0.9962196</span></span>
<span><span class="co">#&gt; p_1step_exo      0.9971924    0.9962292     0.9955017   1.0000000   0.9992707</span></span>
<span><span class="co">#&gt; p_2step_exo      0.9962132    0.9969484     0.9962196   0.9992707   1.0000000</span></span>
<span><span class="co">#&gt; p_10step_exo     0.9956397    0.9963593     0.9965418   0.9989497   0.9996771</span></span>
<span><span class="co">#&gt;               p_10step_exo</span></span>
<span><span class="co">#&gt; p_1step_endo     0.9956397</span></span>
<span><span class="co">#&gt; p_2step_endo     0.9963593</span></span>
<span><span class="co">#&gt; p_10step_endo    0.9965418</span></span>
<span><span class="co">#&gt; p_1step_exo      0.9989497</span></span>
<span><span class="co">#&gt; p_2step_exo      0.9996771</span></span>
<span><span class="co">#&gt; p_10step_exo     1.0000000</span></span></code></pre></div>
<p>Evidently (and as expected) these predictions are all very highly
correlated with each other. Note that there are going to be missing (NA)
values at the front end of the prediction vector, since some
observations are eaten up by lags in the fitting procedure.</p>
</div>
<div class="section level3">
<h3 id="cumulative-predictions">Cumulative predictions<a class="anchor" aria-label="anchor" href="#cumulative-predictions"></a>
</h3>
<p>From an applied perspective, it’s not very useful to predict how many
visits an ED might see in the next hour, or in the next 10 hours. It’s
much more useful to be able to predict how many patients might come in
in a given 10 hour (shift-length) period. The
<code>predict.fastTS</code> function provides some functionality for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>-step
ahead <em>cumulative</em> (rolling sum) predictions via the
<code>cumulative</code> argument.</p>
<p>Let’s calculate 10-hour rolling sum predictions using the 1-10 step
ahead predictions using both models.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_c10hr</span> <span class="op">&lt;-</span> <span class="fu">RcppRoll</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RcppRoll/man/RcppRoll-exports.html" class="external-link">roll_sum</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">10</span>, align <span class="op">=</span> <span class="st">"right"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">p_10step_csum_endo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpac</span>, n_ahead <span class="op">=</span> <span class="fl">10</span>, cumulative <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">p_10step_csum_exo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">srlpacx</span>, n_ahead <span class="op">=</span> <span class="fl">10</span>, cumulative <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can compute mean absolute error (MAE) (and other similar metrics)
using the functionality from the <code>yardstick</code> package.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mae_vec</span><span class="op">(</span><span class="va">y_c10hr</span>, <span class="va">p_10step_csum_endo</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6.99226</span></span>
<span><span class="fu">mae_vec</span><span class="op">(</span><span class="va">y_c10hr</span>, <span class="va">p_10step_csum_exo</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6.88724</span></span></code></pre></div>
<p>So the SRLPAC(x) methods were able to predict the number of patients
who arrive in a given 10-hour window to within an average of about 6.9
patients.</p>
<p>It may be pertinent to investigate this predictive accuracy only on
the test data set, which can be done by extracting the
<code>train_idx</code> object from the <code>fastTS</code> object.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mae_vec</span><span class="op">(</span><span class="va">y_c10hr</span><span class="op">[</span><span class="op">-</span><span class="va">srlpac</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span>, <span class="va">p_10step_csum_endo</span><span class="op">[</span><span class="op">-</span><span class="va">srlpac</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7.239172</span></span>
<span><span class="fu">mae_vec</span><span class="op">(</span><span class="va">y_c10hr</span><span class="op">[</span><span class="op">-</span><span class="va">srlpacx</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span>, <span class="va">p_10step_csum_exo</span><span class="op">[</span><span class="op">-</span><span class="va">srlpacx</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7.154257</span></span></code></pre></div>
<p>We can also compute the overall R-squared:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rsq_vec</span><span class="op">(</span><span class="va">y_c10hr</span>, <span class="va">p_10step_csum_endo</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8449232</span></span>
<span><span class="fu">rsq_vec</span><span class="op">(</span><span class="va">y_c10hr</span>, <span class="va">p_10step_csum_exo</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8510801</span></span></code></pre></div>
<p>And the R-squared just for the test data.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rsq_vec</span><span class="op">(</span><span class="va">y_c10hr</span><span class="op">[</span><span class="op">-</span><span class="va">srlpac</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span>, <span class="va">p_10step_csum_endo</span><span class="op">[</span><span class="op">-</span><span class="va">srlpac</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8326353</span></span>
<span><span class="fu">rsq_vec</span><span class="op">(</span><span class="va">y_c10hr</span><span class="op">[</span><span class="op">-</span><span class="va">srlpacx</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span>, <span class="va">p_10step_csum_exo</span><span class="op">[</span><span class="op">-</span><span class="va">srlpacx</span><span class="op">$</span><span class="va">train_idx</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8382712</span></span></code></pre></div>
<p>It’s interesting that R-squared increases as the horizon for the
cumulative predictions increases: it’s about 0.8 for the 10-hour
cumulative predictions yet only about 0.53 for the standard 1-step
predictions. It seems to imply some predictive gains in the process of
aggregating to longer periods of time. More investigation may be
warranted here.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>In <a href="https://arxiv.org/abs/2211.01492" class="external-link">ongoing work</a> we are
comparing the SRL-based approaches to other competing approaches.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ryan Andrew Peterson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
